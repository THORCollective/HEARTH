name: Autonomous Daily Hunt Generation

on:
  schedule:
    # Run at 8 AM UTC (3 AM EST / 4 AM EDT)
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      max_hunts:
        description: 'Maximum number of hunts to generate'
        required: false
        default: '5'
        type: string
      dry_run:
        description: 'Run in dry-run mode (no changes)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

env:
  PYTHON_VERSION: '3.11'

jobs:
  generate-hunts:
    runs-on: ubuntu-latest
    outputs:
      hunts_generated: ${{ steps.generate.outputs.hunts_generated }}
      hunt_ids: ${{ steps.generate.outputs.hunt_ids }}
      branch_name: ${{ steps.branch.outputs.branch_name }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.HEARTH_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install feedparser  # Additional dependency for RSS parsing

      - name: Download MITRE ATT&CK Data
        run: |
          mkdir -p data
          curl -s -o data/enterprise-attack.json \
            https://raw.githubusercontent.com/mitre/cti/master/enterprise-attack/enterprise-attack.json
          echo "Downloaded MITRE ATT&CK data: $(du -h data/enterprise-attack.json | cut -f1)"

      - name: Create Working Directories
        run: |
          mkdir -p .hearth/intel-drops
          mkdir -p .hearth/processed-intel-drops
          mkdir -p .hearth/auto-drafts

      - name: Load State File
        id: state
        run: |
          if [ -f ".hearth/autonomous-state.json" ]; then
            echo "State file exists"
            cat .hearth/autonomous-state.json | jq -r '.stats'
          else
            echo "No existing state file"
          fi

      - name: Generate Branch Name
        id: branch
        run: |
          BRANCH_NAME="autonomous/hunts-$(date +%Y-%m-%d)"
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Branch name: $BRANCH_NAME"

      - name: Create or Checkout Branch
        run: |
          git config --global user.name 'hearthbot'
          git config --global user.email 'hearthbot@users.noreply.github.com'

          BRANCH_NAME="${{ steps.branch.outputs.branch_name }}"

          # Check if branch exists remotely
          if git ls-remote --heads origin "$BRANCH_NAME" | grep -q "$BRANCH_NAME"; then
            echo "Branch exists, checking out"
            git checkout "$BRANCH_NAME"
            git pull origin "$BRANCH_NAME"
          else
            echo "Creating new branch"
            git checkout -b "$BRANCH_NAME"
          fi

      - name: Run Autonomous Hunt Generator
        id: generate
        env:
          AI_PROVIDER: ${{ vars.AI_PROVIDER || 'claude' }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          CLAUDE_MODEL: ${{ vars.CLAUDE_MODEL || 'claude-sonnet-4-5-20250929' }}
        run: |
          MAX_HUNTS="${{ github.event.inputs.max_hunts || '5' }}"
          DRY_RUN="${{ github.event.inputs.dry_run || 'false' }}"

          CMD="python scripts/autonomous_hunt_generator.py --max-hunts $MAX_HUNTS"

          if [ "$DRY_RUN" == "true" ]; then
            CMD="$CMD --dry-run"
          fi

          echo "Running: $CMD"
          $CMD

      - name: Check for Changes
        id: changes
        run: |
          if git diff --quiet && git diff --staged --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No changes to commit"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected"
            git status
          fi

      - name: Commit and Push Changes
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.dry_run != 'true'
        run: |
          # Stage all hunt files and state
          git add Flames/*.md || true
          git add .hearth/autonomous-state.json || true
          git add .hearth/processed-intel-drops/* || true

          # Get count of new hunts
          HUNTS_GENERATED="${{ steps.generate.outputs.hunts_generated || '0' }}"

          # Create commit message
          COMMIT_MSG="feat(autonomous): Generate $HUNTS_GENERATED hunts from daily intel scan

          Generated by autonomous-daily-hunts workflow
          Run time: $(date -u +%Y-%m-%dT%H:%M:%SZ)

          Hunt IDs: ${{ steps.generate.outputs.hunt_ids || 'none' }}"

          git commit -m "$COMMIT_MSG" || echo "Nothing to commit"

          # Push changes
          git push --set-upstream origin ${{ steps.branch.outputs.branch_name }}

      - name: Upload Run Summary
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: autonomous-run-summary
          path: |
            .hearth/last_run_summary.txt
            .hearth/intel-drops/fetch_summary.json
          retention-days: 30

  create-pr:
    needs: generate-hunts
    if: needs.generate-hunts.outputs.hunts_generated > 0 && github.event.inputs.dry_run != 'true'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.HEARTH_TOKEN }}

      - name: Checkout Generated Branch
        run: |
          git fetch origin ${{ needs.generate-hunts.outputs.branch_name }}
          git checkout ${{ needs.generate-hunts.outputs.branch_name }}

      - name: Check for Existing PR
        id: check_pr
        env:
          GH_TOKEN: ${{ secrets.HEARTH_TOKEN }}
        run: |
          BRANCH="${{ needs.generate-hunts.outputs.branch_name }}"
          EXISTING_PR=$(gh pr list --head "$BRANCH" --json number --jq '.[0].number')

          if [ -n "$EXISTING_PR" ]; then
            echo "pr_exists=true" >> $GITHUB_OUTPUT
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
            echo "Existing PR found: #$EXISTING_PR"
          else
            echo "pr_exists=false" >> $GITHUB_OUTPUT
            echo "No existing PR found"
          fi

      - name: Create Pull Request
        if: steps.check_pr.outputs.pr_exists != 'true'
        env:
          GH_TOKEN: ${{ secrets.HEARTH_TOKEN }}
        run: |
          HUNT_COUNT="${{ needs.generate-hunts.outputs.hunts_generated }}"
          HUNT_IDS="${{ needs.generate-hunts.outputs.hunt_ids }}"
          DATE=$(date +%Y-%m-%d)
          RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

          # Create PR body using HEREDOC with variable expansion
          PR_BODY=$(cat <<EOF
          ## Autonomous Hunt Generation

          This PR contains **${HUNT_COUNT}** threat hunts automatically generated from daily security intel.

          ### Generated Hunts
          ${HUNT_IDS}

          ### Sources
          - CISA Known Exploited Vulnerabilities
          - The Hacker News
          - tldrsec

          ### Review Checklist
          - [ ] Hypotheses are specific and actionable
          - [ ] MITRE ATT&CK mappings are accurate
          - [ ] No duplicate hunts
          - [ ] References are valid

          ---

          **Generated by:** [autonomous-daily-hunts](${RUN_URL})
          **Run Date:** ${DATE}
          EOF
          )

          gh pr create \
            --title "feat(autonomous): Daily hunt generation - $DATE ($HUNT_COUNT hunts)" \
            --body "$PR_BODY" \
            --base main \
            --head "${{ needs.generate-hunts.outputs.branch_name }}" \
            --label "autonomous" \
            --label "hunt-review" \
            --draft

      - name: Update Existing PR
        if: steps.check_pr.outputs.pr_exists == 'true'
        env:
          GH_TOKEN: ${{ secrets.HEARTH_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.check_pr.outputs.pr_number }}"
          HUNT_COUNT="${{ needs.generate-hunts.outputs.hunts_generated }}"
          DATE=$(date +%Y-%m-%d)

          gh pr comment "$PR_NUMBER" --body "Updated with $HUNT_COUNT additional hunts at $DATE

          Run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

  notify-failure:
    needs: [generate-hunts, create-pr]
    if: failure()
    runs-on: ubuntu-latest

    steps:
      - name: Log Failure
        run: |
          echo "Autonomous hunt generation failed"
          echo "Run ID: ${{ github.run_id }}"
          echo "Run URL: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"

      # Optional: Add Slack/Discord notification here
      # - name: Send Notification
      #   uses: ...
