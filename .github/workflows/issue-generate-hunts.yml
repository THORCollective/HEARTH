name: "Issue-Driven HEARTH Draft Generation"

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

jobs:
  # This job runs when an issue is labeled, prompting the user to add their file.
  request-file:
    # We only want this to run when the 'intel-submission' label is first added.
    if: github.event_name == 'issues' && github.event.label.name == 'intel-submission'
    runs-on: ubuntu-latest
    permissions:
      issues: write
    steps:
      - name: "Post a comment to request the CTI file"
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            âœ… Thank you for your submission, @${{ github.event.issue.user.login }}!

            Please attach your CTI file (e.g., a PDF or .txt file) in a new comment below to begin the automated drafting process.
          reactions: '+1'

  # This job runs on every new comment, but only proceeds if it finds an attachment.
  process-file:
    # We only want this to run on comments on issues that have the right label.
    if: contains(github.event.issue.labels.*.name, 'intel-submission')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
    steps:
      - name: "Checkout Repo"
        uses: actions/checkout@v4

      - name: "Download Attachments from Comment"
        id: download
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          INTEL_DROP_PATH: ".hearth/intel-drops"
        run: |
          set -e
          mkdir -p $INTEL_DROP_PATH
          urls=$(echo "$COMMENT_BODY" | grep -o 'https://github.com/.*')
          if [ -z "$urls" ]; then
            echo "No attachment URLs found in comment."
            echo "any_downloaded=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          for url in $urls; do
            # The URL in the comment is the HTML page, not the raw asset.
            # We need to get the real download URL.
            # This is a bit of a hack, but it works for GitHub's structure.
            asset_url=$(echo "$url" | sed 's|github.com|uploads.github.com|' | sed 's|/files/|/assets/|')
            
            # Use gh to securely download the asset
            gh api "$asset_url" --header 'Accept: application/octet-stream' > "$INTEL_DROP_PATH/$(basename $url)"
            
            echo "Downloaded $(basename $url)"
          done
          echo "any_downloaded=true" >> $GITHUB_OUTPUT

      - name: "Check if a file was downloaded"
        if: steps.download.outputs.any_downloaded == 'false'
        run: |
          echo "No file was attached to this comment. Skipping."
          exit 0

      - name: "Set up Python 3"
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: "Install dependencies"
        run: |
          python -m pip install --upgrade pip
          pip install openai python-dotenv PyPDF2

      - name: "Run HEARTH draft generator"
        id: generate_draft
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python scripts/generate_from_cti.py

      - name: "Create Pull Request"
        id: create_pr
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "feat(hunt): New hunt draft from issue #${{ github.event.issue.number }}"
          committer: "hearthbot <hearthbot@users.noreply.github.com>"
          author: "${{ github.event.comment.user.login }} <${{ github.event.comment.user.login }}@users.noreply.github.com>"
          branch: "hearth/issue-${{ github.event.issue.number }}-${{ github.event.comment.id }}"
          delete-branch: true
          title: "ðŸ”¥ Hunt Draft from Issue #${{ github.event.issue.number }}"
          body: |
            This PR was automatically generated from a file attached to a comment in issue #${{ github.event.issue.number }}.
            
            - **Submitter**: @${{ github.event.comment.user.login }}
            - **Source Issue**: #${{ github.event.issue.number }}
            
            Please review the generated hunt below.
            
            Closes #${{ github.event.issue.number }}
          labels: "needs-review, automated-draft"
          assignees: "${{ github.event.comment.user.login }}"

      - name: "Comment on issue with PR link"
        if: steps.create_pr.outputs.pull-request-number
        uses: peter-evans/create-or-update-comment@v4
        with:
          issue-number: ${{ github.event.issue.number }}
          body: |
            ðŸ“„ Your file has been processed and a draft pull request has been created. Thank you!
            
            ðŸ”— **View PR**: #${{ steps.create_pr.outputs.pull-request-number }} 